language: cpp

env:
  global:
    - ANDROID_API_LEVEL=17
    - ANDROID_SDK_VERSION=24.0.2
    - ANDROID_NDK_VERSION=9
    - ANDROID_BUILD_TOOLS_VERSION=20.0.0

  matrix:
    - TARGET=ANDROID
    - TARGET=UNIX
    - TARGET=PC
    - TARGET=WIN64
    - TARGET=WM5
    - TARGET=WM5X
    - TARGET=PPC2000
    - TARGET=PPC2003
    - TARGET=PPC2003X
    - TARGET=ALTAIR
    - TARGET=MANUAL

before_install:
  - sudo apt-get update

  - openssl aes-256-cbc
    -K $encrypted_cd16ea2a7c97_key
    -iv $encrypted_cd16ea2a7c97_iv
    -in xcsoar-release.keystore.enc
    -out xcsoar-release.keystore -d

install:
  # General

  - sudo apt-get install make g++ libsdl-image1.2-dev libboost-dev
      zlib1g-dev libsdl1.2-dev libfreetype6-dev libpng-dev libjpeg-dev
      libcurl4-openssl-dev libxml-parser-perl librsvg2-bin xsltproc
      imagemagick gettext ttf-dejavu

  # PC

  - if [ "$TARGET" = "PC" ]; then
      sudo apt-get install binutils-mingw-w64-i686 gcc-mingw-w64-i686 g++-mingw-w64-i686;
    elif [ "$TARGET" = "WIN64" ]; then
      sudo apt-get install binutils-mingw-w64-x86-64 gcc-mingw-w64-x86-64 g++-mingw-w64-x86-64;
    fi

  # Android

  - if [ "$TARGET" = "ANDROID" ]; then
      mkdir -p ~/opt;

      wget http://dl.google.com/android/ndk/android-ndk-r$ANDROID_NDK_VERSION-linux-x86_64.tar.bz2;
      tar -xf android-ndk-r$ANDROID_NDK_VERSION-linux-x86_64.tar.bz2 -C ~/opt;
      rm android-ndk-r$ANDROID_NDK_VERSION-linux-x86_64.tar.bz2;

      wget http://dl.google.com/android/android-sdk_r$ANDROID_SDK_VERSION-linux.tgz;
      tar -xf android-sdk_r$ANDROID_SDK_VERSION-linux.tgz -C ~/opt;
      rm android-sdk_r$ANDROID_SDK_VERSION-linux.tgz;

      sudo apt-get install openjdk-7-jre-headless openjdk-7-jdk ant vorbis-tools;

      if [ `uname -m` = x86_64 ]; then
        sudo apt-get install libncurses5:i386 libstdc++6:i386 zlib1g:i386;
      fi

      echo 'y' | ~/opt/android-sdk-linux/tools/android update sdk --no-ui --all --filter platform-tools;
      echo 'y' | ~/opt/android-sdk-linux/tools/android update sdk --no-ui --all --filter build-tools-$ANDROID_BUILD_TOOLS_VERSION,android-$ANDROID_API_LEVEL;
    fi

  # Windows Mobile

  - if [[ "$TARGET" == "WM"* ]] || [[ "$TARGET" == "PPC"* ]] || [ "$TARGET" = "ALTAIR" ]; then
      wget http://spekje.snt.utwente.nl/~roel/cegcc/mingw32ce-mk-2013-04-03-amd64.tar.xz;
      tar -xJf mingw32ce-mk-2013-04-03-amd64.tar.xz -C ~/;
      export PATH="/home/travis/mingw32ce-mk-2013-04-03-amd64/bin:$PATH";
    fi

  # Manual

  - if [ "$TARGET" = "MANUAL" ]; then
      sudo apt-get install --no-install-recommends
        texlive texlive-latex-extra latex-xcolor pgf liblocale-po-perl
        texlive-lang-ukenglish texlive-lang-german texlive-lang-french;
    fi

after_install: sudo apt-get clean

before_script:
  - if [ "$TRAVIS_TAG" ]; then
      export DEBUG=n;
    fi

script:
  # Compile

  - if [ "$TARGET" = "MANUAL" ]; then
      make -j8 TARGET=UNIX manual;
    elif [ "$TARGET" = "ANDROID" ]; then
      make -j8 TARGET=ANDROID;
    else
      make -j8 TARGET=$TARGET everything;
    fi

  # Run unit tests on platforms where possible (Unix)

  - if [ "$TARGET" = "UNIX" ]; then
      make TARGET=$TARGET check;
    fi

notifications:
  email:
    on_failure: change
